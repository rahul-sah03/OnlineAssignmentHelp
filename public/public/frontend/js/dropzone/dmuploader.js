var rename;(function($){var pluginName='dmUploader';var filenames=new Array;var defaults={url:document.URL,method:'POST',extraData:{},maxFileSize:10762150,maxFiles:5,allowedTypes:'*',extFilter:'png;jpg;jpeg;tif;ai;cdr;pdf;psd;doc;docx;csv;odt;xls;xlsx;ppt;pptx;rtf;txt;sql;mpp;zip;rar',dataType:null,fileName:'file',onInit:function(){},onFallbackMode:function(message){},onNewFile:function(id,file){},onBeforeUpload:function(id){},onComplete:function(){},onUploadProgress:function(id,percent){},onUploadSuccess:function(id,data){},onUploadError:function(id,message){},onFileTypeError:function(file){},onFileSizeError:function(file){},onFileExtError:function(file){},onFilesMaxError:function(file){}};var DmUploader=function(element,options){this.element=$(element);this.settings=$.extend({},defaults,options);if(!this.checkBrowser()){return false;}this.init();return true;};DmUploader.prototype.checkBrowser=function(){if(window.FormData===undefined){this.settings.onFallbackMode.call(this.element,'Browser doesn\'t support Form API');return false;}if(this.element.find('input[type=file]').length>0){return true;}if(!this.checkEvent('drop',this.element)||!this.checkEvent('dragstart',this.element)){this.settings.onFallbackMode.call(this.element,'Browser doesn\'t support Ajax Drag and Drop');return false;}return true;};DmUploader.prototype.checkEvent=function(eventName,element){var element=element||document.createElement('div');var eventName='on'+eventName;var isSupported=eventName in element;if(!isSupported){if(!element.setAttribute){element=document.createElement('div');}if(element.setAttribute&&element.removeAttribute){element.setAttribute(eventName,'');isSupported=typeof element[eventName]=='function';if(typeof element[eventName]!='undefined'){element[eventName]=undefined;}element.removeAttribute(eventName);}}element=null;return isSupported;};DmUploader.prototype.init=function(){var widget=this;widget.queue=new Array();widget.queuePos=-1;widget.queueRunning=false;widget.element.on('drop',function(evt){evt.preventDefault();var files=evt.originalEvent.dataTransfer.files;widget.queueFiles(files);});widget.element.find('input[type=file]').on('change',function(evt){var files=evt.target.files;widget.queueFiles(files);$(this).val('');});this.settings.onInit.call(this.element);};DmUploader.prototype.queueFiles=function(files){var j=this.queue.length;for(var i=0;i<files.length;i++){var file=files[i];if((this.settings.maxFileSize>0)&&(file.size>this.settings.maxFileSize)){this.settings.onFileSizeError.call(this.element,file);continue;}if((this.settings.allowedTypes!='*')&&!file.type.match(this.settings.allowedTypes)){this.settings.onFileTypeError.call(this.element,file);continue;}if(this.settings.extFilter!=null){var extList=this.settings.extFilter.toLowerCase().split(';');var ext=file.name.toLowerCase().split('.').pop();if($.inArray(ext,extList)<0){this.settings.onFileExtError.call(this.element,file);continue;}}if(this.settings.maxFiles>0){if(this.queue.length>=this.settings.maxFiles){this.settings.onFilesMaxError.call(this.element,file);continue;}}file.user=Date.now()+file.name;filenames.push(file.user);this.queue.push(file);var index=this.queue.length-1;this.settings.onNewFile.call(this.element,index,file);}if(this.queueRunning){return false;}if(this.queue.length==j){return false;}this.processQueue();return true;};window.rename=filenames;DmUploader.prototype.processQueue=function(){var widget=this;widget.queuePos++;if(widget.queuePos>=widget.queue.length){widget.settings.onComplete.call(widget.element);widget.queuePos=(widget.queue.length-1);widget.queueRunning=false;return;}var file=widget.queue[widget.queuePos];var fd=new FormData();fd.append(widget.settings.fileName,file);var can_continue=widget.settings.onBeforeUpload.call(widget.element,widget.queuePos);if(false===can_continue){return;}$.each(widget.settings.extraData,function(exKey,exVal){fd.append(exKey,exVal);});widget.queueRunning=true;$.ajax({url:widget.settings.url,type:widget.settings.method,dataType:widget.settings.dataType,data:fd,cache:false,contentType:false,processData:false,forceSync:false,xhr:function(){var xhrobj=$.ajaxSettings.xhr();if(xhrobj.upload){xhrobj.upload.addEventListener('progress',function(event){var percent=0;var position=event.loaded||event.position;var total=event.total||event.totalSize;if(event.lengthComputable){percent=Math.ceil(position/total*100);}widget.settings.onUploadProgress.call(widget.element,widget.queuePos,percent);},false);}return xhrobj;},success:function(data,message,xhr){widget.settings.onUploadSuccess.call(widget.element,widget.queuePos,data);},error:function(xhr,status,errMsg){widget.settings.onUploadError.call(widget.element,widget.queuePos,errMsg);},complete:function(xhr,textStatus){widget.processQueue();}});}
$.fn.dmUploader=function(options){return this.each(function(){if(!$.data(this,pluginName)){$.data(this,pluginName,new DmUploader(this,options));}});};$(document).on('dragenter',function(e){e.stopPropagation();e.preventDefault();});$(document).on('dragover',function(e){e.stopPropagation();e.preventDefault();});$(document).on('drop',function(e){e.stopPropagation();e.preventDefault();});})(jQuery);